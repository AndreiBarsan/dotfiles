#!/usr/bin/env bash
# Give me a devbox!
#
# Not a super robust script, since the Opus CLI/output/API may change at any
# time, but can help save some time.
#
# Author: andreib@uber.com

NAME="$USER-dev"
OPUS="opus -da wbu2/da1"
echo "Will use $NAME as the devbox name."

echo "Getting current status of devbox $NAME..."
INSPECT=$($OPUS devbox inspect "$NAME" 2>&1)
if [[ "$INSPECT" =~ 'not a known devbox' ]]; then
  echo "The devbox $NAME has not been set up yet. Starting wizard..."
  $OPUS devbox create -n "$NAME" --walkthrough
  exit 0
fi

STATE=$(echo "$INSPECT" | grep "state" | cut -d '"' -f4)
echo "Devbox exists. Current status [$STATE]."

echo "Not moving forward because the create -n NAME --restart command seems " \
     "to be freezing often. Odd."
exit

if [[ "$STATE" == "RUNNING" ]]; then
  echo "Devbox $NAME is running. Nothing to do."
else
  echo "Devbox $NAME exists but is not running. Restarting..."
  $OPUS devbox create -n "$NAME" --restart
fi

